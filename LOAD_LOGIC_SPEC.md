# 負荷計算およびヒートマップ表示の仕様

このドキュメントでは、本アプリにおける練習負荷の計算方法、およびカレンダー上のヒートマップ（色分け）の判定ロジックについて説明します。

## 1. 単一セッションの負荷計算

1つの練習（セッション）の負荷は、以下の優先順位で計算されます。

### ① ペース由来負荷 (rTSS 風)
距離とペースの両方が入力されている場合に適用されます。
- **計算式**: `距離(km) × (基準ペース / 実際のエース) × 15`
- **基準ペース**: 5:00/km (300秒)
- **特徴**: 速いペースほど、また距離が長いほど負荷が高くなります（1時間 5:00/km走 = 180負荷）。

### ② sRPE 負荷 (主観的強度 × 時間)
RPE（自覚的運動強度 0-10）と練習時間が入力されている場合に適用されます（①が計算できない場合）。
- **計算式**: `RPE(0-10) × 練習時間(分)`
- **特徴**: ペースが計測できないジョグや補強運動など、主観的なキツさをベースに負荷を算出します。

### ③ ゾーン負荷 (強度ゾーン × 時間)
強度ゾーン（E, M, T, I, R）と練習時間が入力されている場合に適用されます（①, ②が計算できない場合）。
- **計算式**: `ゾーン係数 × 練習時間(分) × 3`
- **ゾーン係数**:
  - E (Easy): 1.0 (負荷換算: 3.0/分)
  - M (Marathon): 1.5 (負荷換算: 4.5/分)
  - T (Threshold): 2.0 (負荷換算: 6.0/分)
  - I (Interval): 3.0 (負荷換算: 9.0/分)
  - R (Repetition): 4.0 (負荷換算: 12.0/分)

---

## 2. カレンダーのヒートマップ（濃淡）表示

カレンダーのセルの背景色は、**ACWR (Acute:Chronic Workload Ratio) 概念**に基づいた負荷比率によって決定されます。

### 比率の計算
- **Acute Load (急性的負荷)**: その日の合計負荷。
- **Chronic Load (慢性的負荷/能力)**: 過去42日間の練習負荷の指数加重移動平均 (EWMA)。
- **比率 (Ratio)**: `当日負荷 / 慢性的負荷`

> [!NOTE]
> **初期データへの配慮**
> 使い始めなどで過去のデータ（慢性的負荷）が極端に少ない場合、比率が異常に高くなり真っ赤に表示されるのを防ぐため、**慢性的負荷が 60.0 未満の場合は比率を 0 (評価なし)** として扱います。これは「1時間のEペース走(180)を週数回行うレベル」が定着し始めるまでの期間に相当します。

### 色分けの閾値 (Heatmap Buckets)

比率に基づいて以下の7段階で色分けされます。

| 段階 (Bucket) | 比率の範囲 (Ratio) | 意味 | 表示色 |
| :--- | :--- | :--- | :--- |
| 0 | 0.0 (またはデータ不足) | 負荷なし / 評価不能 | 薄いグレー |
| 1 | 0.0 < Ratio < 0.5 | 非常に軽い | 淡い青 |
| 2 | 0.5 <= Ratio < 0.8 | 軽い | 淡い緑 |
| 3 | 0.8 <= Ratio < 1.2 | 普通（適正） | 緑 |
| 4 | 1.2 <= Ratio < 1.5 | やや高い | 黄色 |
| 5 | 1.5 <= Ratio < 2.0 | 高い | オレンジ |
| 6 | 2.0 <= Ratio | 非常に高い（過負荷） | 赤 |

---

## 3. 実装上の注意点
- 慢性的負荷の計算には過去最大84日分のデータを参照し、直近の練習ほど重みを置いて平均化しています。
- 予定（Plan）のみの日は、セッション数 0 として扱われるため、ヒートマップの色はつきません（枠線のみの表示）。
